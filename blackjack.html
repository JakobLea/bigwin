<?php
session_start();

if (isset($_SESSION['id']) && isset($_SESSION['user_name'])) {

?>
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="Logo/Favicon.png">
    <title>Blackjack Game</title>
    <link rel="stylesheet" href="bj.css">
    <link rel="stylesheet" href="nav.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
        }

        #game {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #player,
        #dealer {
            display: flex;
            align-items: center;
            margin: 10px;
        }

        .hand {
            margin-right: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
        }

        /* Add a border to the player's cards */
        .player-loose-card {
            border: 5px solid #ff0000;
            border-radius: 7px;
            background-color: red;
        }

        /* Add a green border to the player's cards when they win */
        .player-win-card {
            border: 5px solid #00ff00;
            border-radius: 7px;
            background-color: #00ff00;
        }

        .player-push-card {
            border: 5px solid #ff8800;
            border-radius: 7px;
            background-color: #ff8800;
        }

        .card-image {
            width: 100px;
            height: 150px;
            margin: 10px;
        }

        .counter {
            font-size: 24px;
        }
    </style>
</head>

<body style="background-color:#333333">
    <nav class="navbar">
        <a href="home.php" class="nav-branding"> <img style="border:0px solid black;" src="Logo/BigWin3.png"
                width=100px, height=50px></a>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="mines.php" class="nav-link">Mines</a>
            </li>
            <li class="nav-item">
                <a href="Penger.php" class="nav-link">Penger</a>
            </li>
            <li class="nav-item">
                <a href="blackjack.php" class="nav-link">Blackjack</a>
            </li>
            <li class="nav-item">
                <a href="Kontakt.html" class="nav-link">Kontakt</a>
            </li>
        </ul>
        <div class="login-container">
            <li class="nav-item">
                <div id="coinCount"></div>
            </li>

            <li class="nav-item">
                <a href="Login.html" class="nav-link">Login</a>
            </li>
        </div>
        <div class="hamburger">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
    </nav>

    <div id="container">
        <div id="game">
            <div id="player">
                <h2>Player's Hand:</h2>
                <div class="counter" id="player-counter"></div>
                <div id="player-hand" class="hand"></div>
            </div>
            <div id="dealer">
                <h2>Dealer's Hand:</h2>
                <div class="counter" id="dealer-counter"></div>
                <div id="dealer-hand" class="hand"></div>
            </div>
            <button id="deal-button">Deal</button>
            <button id="hit-button">Hit</button>
            <button id="stand-button">Stand</button>
        </div>
    </div>

    <script>
        const suits = ["Hearts", "Diamonds", "Clubs", "Spades"];
        const ranks = ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"];

        let deck = [];
        let playerHand = [];
        let dealerHand = [];

        const playerHandElement = document.getElementById("player-hand");
        const dealerHandElement = document.getElementById("dealer-hand");
        const playerCounterElement = document.getElementById("player-counter");
        const dealerCounterElement = document.getElementById("dealer-counter");
        const dealButton = document.getElementById("deal-button");
        const hitButton = document.getElementById("hit-button");
        const standButton = document.getElementById("stand-button");
        let dealerCardHidden = true; // Dealer's first card is hidden.

        function createDeck() {
            for (let suit of suits) {
                for (let rank of ranks) {
                    deck.push({ suit, rank });
                }
            }
        }

        function shuffleDeck() {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function dealInitialCards() {
            if (deck.length < 4) {
                // If there are fewer than 4 cards left, reshuffle the deck.
                createDeck();
                shuffleDeck();
            }

            // Clear previous cards only when the game is redealt.
            playerHand = [];
            dealerHand = [];
            dealerCardHidden = true; // Reset dealer's first card as hidden.

            for (let i = 0; i < 2; i++) {
                if (deck.length === 0) {
                    // If the deck is empty, reshuffle the deck.
                    createDeck();
                    shuffleDeck();
                }
                playerHand.push(deck.pop());
                if (deck.length === 0) {
                    // If the deck is empty, reshuffle the deck.
                    createDeck();
                    shuffleDeck();
                }
                dealerHand.push(deck.pop());
            }
            renderHands();
            dealButton.disabled = true;
            hitButton.disabled = false;
            standButton.disabled = false;

            // Check if the player has blackjack
            checkPlayerBlackjack();
        }


        // Function to check if the player has blackjack (initial hand value of 21)
        function checkPlayerBlackjack() {
            if (calculateHandValue(playerHand) === 21) {
                dealerCardHidden = false;
                renderHands();
                if (calculateHandValue(dealerHand) === 21) {
                    endGame("It's a push!");
                } else {
                    endGame("You win!");
                }
            }
        }


        
        // Function to load card images with a placeholder (back of the card)
        function loadCardImages(cards, element, callback) {
            let loadedImages = 0;

            cards.forEach((card, index) => {
                const image = new Image();
                image.onload = function () {
                    loadedImages++;
                    if (loadedImages === cards.length) {
                        callback();
                    }
                };
                image.src = `Cards/${getRankSymbol(card.rank)}${getSuitSymbol(card.suit)}.png`;
                image.alt = `${card.rank} of ${card.suit}`;
                image.classList.add('card-image');

                // Display the back of the card as a placeholder
                if (index === 0 && dealerCardHidden) {
                    image.src = 'Cards/bak.png';
                }

                element.appendChild(image);
            });
        }



        // Function to load card images and render hands
        function renderHands() {
            playerHandElement.innerHTML = '';
            dealerHandElement.innerHTML = '';

            loadCardImages(playerHand, playerHandElement, () => {
                loadCardImages(dealerHand, dealerHandElement, () => {
                    playerCounterElement.textContent = `Total: ${calculateHandValue(playerHand)}`;

                    // Update the dealer's card counter including the hidden card
                    if (dealerCardHidden) {
                        dealerCounterElement.textContent = 'Total: ?';
                    } else {
                        dealerCounterElement.textContent = `Total: ${calculateHandValue(dealerHand)}`;
                    }
                });
            });
        }


        function getCardImageURL(card) {
            const suitSymbol = getSuitSymbol(card.suit);
            const rankSymbol = getRankSymbol(card.rank);

            return `<img class="card-image" src="Cards/${rankSymbol}${suitSymbol}.png" alt="${card.rank} of ${card.suit}">`;
        }

        function getCardImageImageHTML(card, index) {
            const suitSymbol = getSuitSymbol(card.suit);
            const rankSymbol = getRankSymbol(card.rank);
            const cardImageHTML = `<img class="card-image" src="Cards/${rankSymbol}${suitSymbol}.png" alt="${card.rank} of ${card.suit}">`;

            // If the dealer's first card is hidden, show the back of the card.
            if (index === 0 && dealerCardHidden) {
                return '<img class="card-image" src="Cards/bak.png" alt="Card Back">';
            }

            return cardImageHTML;
        }

        function getSuitSymbol(suit) {
            switch (suit) {
                case "Hearts":
                    return "H";
                case "Diamonds":
                    return "D";
                case "Clubs":
                    return "C";
                case "Spades":
                    return "S";
            }
        }

        function getRankSymbol(rank) {
            return rank === "10" ? "T" : rank;
        }

        function calculateHandValue(hand) {
            let value = 0;
            let hasAce = false;

            for (let card of hand) {
                if (card.rank === "A") {
                    hasAce = true;
                }
                if (card.rank === "K" || card.rank === "Q" || card.rank === "J") {
                    value += 10;
                } else if (card.rank === "A") {
                    value += 11;
                } else {
                    value += parseInt(card.rank);
                }
            }

            if (hasAce && value > 21) {
                value -= 10; // Convert one Ace from 11 to 1.
            }

            return value;
        }

        function endGame(outcome) {
            dealerCardHidden = false;
            renderHands();

            if (outcome === "You Lost") {
                const playerCardImages = playerHandElement.querySelectorAll('.card-image');
                playerCardImages.forEach(image => image.classList.add('player-loose-card'));
            } else if (outcome === "You win!") {
                const playerCardImages = playerHandElement.querySelectorAll('.card-image');
                playerCardImages.forEach(image => image.classList.add('player-win-card'));
            } else if (outcome === "It's a push!") {
                const playerCardImages = playerHandElement.querySelectorAll('.card-image');
                playerCardImages.forEach(image => image.classList.add('player-push-card'));
            }

            hitButton.disabled = true;
            standButton.disabled = true;
            dealButton.disabled = false;
        }

        function checkPlayerWin() {
            const playerValue = calculateHandValue(playerHand);
            const dealerValue = calculateHandValue(dealerHand);

            if (playerValue === 21) {
                if (dealerValue === 21) {
                    endGame("It's a push!");
                } else {
                    endGame("You win!");
                }
            }
        }



        createDeck();
        shuffleDeck();
        renderHands(); // Render initial state

        // Event listeners for the buttons
        dealButton.addEventListener("click", dealInitialCards);
        hitButton.addEventListener("click", () => {
            if (playerHand.length < 5) { // Limit the number of cards a player can have
                if (deck.length === 0) {
                    // If the deck is empty, reshuffle the deck.
                    createDeck();
                    shuffleDeck();
                }
                playerHand.push(deck.pop());
                renderHands();
                if (calculateHandValue(playerHand) > 21) {
                    endGame("You Lost");
                }
                checkPlayerWin(); // Check if the player has 21 and win
            }
        });

        standButton.addEventListener("click", () => {
            while (calculateHandValue(dealerHand) < 17) {
                if (deck.length === 0) {
                    // If the deck is empty, reshuffle the deck.
                    createDeck();
                    shuffleDeck();
                }
                dealerHand.push(deck.pop());
            }
            renderHands();

            if (calculateHandValue(dealerHand) > 21 || calculateHandValue(playerHand) > calculateHandValue(dealerHand)) {
                endGame("You win!");
            } else if (calculateHandValue(playerHand) < calculateHandValue(dealerHand)) {
                endGame("You Lost");
            } else {
                endGame("It's a push!");
            }
        });
    </script>
</body>

</html>

<?php
} else {
    header("Location: index.php");
    exit();
}
?>